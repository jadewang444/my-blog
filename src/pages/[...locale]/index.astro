---
import { i18n } from "astro:config/client";
import { render, getCollection } from "astro:content";
import { getRelativeLocaleUrl } from "astro:i18n";
import Time from "$utils/time";
import Base from "$layouts/Base.astro";
import config from "$config";
import i18nit from "$i18n";

export async function getStaticPaths() {
  // Create path for each locale, omitting default locale from URL
  return i18n!.locales.map(locale => ({
    params: { locale: locale == i18n?.defaultLocale ? undefined : (locale as string) }
  }));
}

const { locale = i18n!.defaultLocale } = Astro.params;
const t = i18nit(locale);

// Preface（当前语言，按时间倒序）
const prefaces = (
  await getCollection("preface", preface => {
    const [language, id] = preface.id.split("/");
    preface.id = id;
    return language == locale;
  })
).sort((a, b) => b.data.timestamp.getTime() - a.data.timestamp.getTime());

// Notes removed from site — we no longer fetch the `note` collection for the homepage

// Jottings（已发布，当前语言）
const jottings = await getCollection("jotting", jotting => {
  const [language] = jotting.id.split("/");
  return !jotting.data.draft && language == locale;
});

// Get featured article
const featuredArticle = jottings.find(article => article.data.featured);

const preface = prefaces[0];
const { Content } = preface ? await render(preface) : ({} as any);
---

<Base title={t("navigation.home")} {locale}>
  <main class="flex flex-col gap-24 sm:gap-32 flex-grow max-w-5xl mx-auto px-6 py-8">
    
    {/* Centered Large Photo */}
    <section class="flex justify-center mt-8">
      <img
        src="/me.png"
        alt="Profile"
        class="shadow-sm"
        style="width: 550px; max-width: 90vw; height: auto; object-fit: cover;"
      />
    </section>

    {/* Preface Section with Date on Next Line, Right-Aligned */}
    {
      preface && (
        <section class="flex flex-col gap-3">
          <article class="markdown">
            <Content />
          </article>
          <a href={getRelativeLocaleUrl(locale, "/preface")} class="self-end text-gray-600" style="font-family: var(--font-body); font-size: 0.9rem;">
            —— {Time.date.locale(preface.data.timestamp, locale)}
          </a>
        </section>
      )
    }

    {/* Featured Article Section - Centered */}
    {featuredArticle && (
      <section class="flex flex-col items-center gap-6 text-center">
        <h2 class="font-normal text-gray-700" style="font-size: 21px;">If you want to know me...</h2>
        <a href={getRelativeLocaleUrl(locale, `/jotting/at-twenty-five`)} 
           class="inline-block font-normal hover:text-gray-700 transition-colors" style="font-size: 18px;">
          At Twenty-Five
        </a>
      </section>
    )}
  </main>
</Base>
