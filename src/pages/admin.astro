---
/**
 * Private analytics dashboard - visible only to admin
 * 
 * Protected by cookie-based session (4-hour expiration)
 * Shows page view counts and last-seen timestamps
 */

import crypto from 'crypto';
import { createClient } from '@supabase/supabase-js';
import Base from '../layouts/Base.astro';

export const prerender = false;

// Helper function to verify signed session
function verifySession(signedSession: string, secret: string): any {
  try {
    const [sessionBase64, signature] = signedSession.split('.');
    
    // Verify signature
    const hmac = crypto.createHmac('sha256', secret);
    hmac.update(sessionBase64);
    const expectedSignature = hmac.digest('hex');
    
    if (signature !== expectedSignature) {
      return null;
    }
    
    // Decode session
    const sessionString = Buffer.from(sessionBase64, 'base64').toString('utf-8');
    const session = JSON.parse(sessionString);
    
    // Check expiration
    if (session.expires <= Date.now()) {
      return null;
    }
    
    return session;
  } catch (e) {
    return null;
  }
}

// Check cookie session
const sessionCookie = Astro.cookies.get('admin_session');
const expectedUser = import.meta.env.ADMIN_USER;
const expectedPass = import.meta.env.ADMIN_PASS;
const secret = import.meta.env.SESSION_SECRET || expectedPass;

if (!expectedUser || !expectedPass) {
  return new Response('Admin credentials not configured', { status: 500 });
}

let authenticated = false;

if (sessionCookie?.value) {
  const session = verifySession(sessionCookie.value, secret);
  if (session && session.username === expectedUser) {
    authenticated = true;
  }
}

if (!authenticated) {
  return Astro.redirect('/admin/login?error=unauthorized');
}

// Fetch analytics data from Supabase (aggregated view)
const supabaseUrl = import.meta.env.SUPABASE_URL;
const supabaseAnonKey = import.meta.env.SUPABASE_ANON_KEY;

if (!supabaseUrl || !supabaseAnonKey) {
  return new Response('Supabase not configured', { status: 500 });
}

const supabase = createClient(supabaseUrl, supabaseAnonKey);

// Query aggregated pageviews view (no raw data, just path + count + last_seen)
const { data: pageviews, error } = await supabase
  .from('pageviews_by_path')
  .select('path, views, last_seen')
  .order('views', { ascending: false });

if (error) {
  console.error('Supabase query error:', error);
  return new Response(`Failed to fetch analytics data: ${error.message}`, { status: 500 });
}

// Format last_seen timestamps
const formatDate = (timestamp: string) => {
  const date = new Date(timestamp);
  return date.toLocaleString('en-US', {
    year: 'numeric',
    month: 'short',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit',
  });
};

const totalViews = pageviews?.reduce((sum: number, p: any) => sum + p.views, 0) || 0;
---

<Base title="Analytics Dashboard" description="Private page view analytics">
  <main class="flex flex-col gap-6">
    <header style="display: flex; justify-content: space-between; align-items: center;">
      <div>
        <h1 style="font-size: 2rem; font-weight: 600; margin-bottom: 0.5rem;">Analytics Dashboard</h1>
        <p style="color: var(--color-secondary, #666);">
          Privacy-friendly page view tracking â€” no cookies, no IPs, no PII.
        </p>
      </div>
      <form method="POST" action="/api/admin/logout">
        <button
          type="submit"
          style="padding: 0.5rem 1rem; background: transparent; border: 1px solid var(--border-color, #e0e0e0); border-radius: 0.25rem; cursor: pointer; font-size: 0.875rem;"
        >
          Logout
        </button>
      </form>
    </header>

    <section>
      <h2 style="font-size: 1.25rem; font-weight: 500; margin-bottom: 1rem;">Summary</h2>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
        <div style="padding: 1rem; border: 1px solid var(--border-color, #e0e0e0); border-radius: 0.5rem;">
          <div style="font-size: 0.875rem; color: var(--color-secondary, #666);">Total Pages</div>
          <div style="font-size: 2rem; font-weight: 600; margin-top: 0.25rem;">{pageviews?.length || 0}</div>
        </div>
        <div style="padding: 1rem; border: 1px solid var(--border-color, #e0e0e0); border-radius: 0.5rem;">
          <div style="font-size: 0.875rem; color: var(--color-secondary, #666);">Total Views</div>
          <div style="font-size: 2rem; font-weight: 600; margin-top: 0.25rem;">{totalViews}</div>
        </div>
      </div>
    </section>

    <section>
      <h2 style="font-size: 1.25rem; font-weight: 500; margin-bottom: 1rem;">Page Views</h2>
      
      <!-- Debug info -->
      <p style="font-size: 0.875rem; color: #999; margin-bottom: 1rem;">
        Debug: pageviews = {pageviews ? `array with ${pageviews.length} items` : 'null/undefined'}
      </p>
      
      {pageviews && pageviews.length > 0 ? (
        <div style="overflow-x: auto;">
          <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
            <thead>
              <tr style="border-bottom: 2px solid var(--border-color, #e0e0e0);">
                <th style="text-align: left; padding: 0.75rem; font-weight: 600;">Path</th>
                <th style="text-align: right; padding: 0.75rem; font-weight: 600;">Views</th>
                <th style="text-align: right; padding: 0.75rem; font-weight: 600;">Last Seen</th>
              </tr>
            </thead>
            <tbody>
              {pageviews.map((pv: any) => (
                <tr style="border-bottom: 1px solid var(--border-color, #e0e0e0);">
                  <td style="padding: 0.75rem; font-family: var(--monospace, monospace);">
                    <a href={pv.path} style="color: var(--color-link, #0066cc); text-decoration: none;">
                      {pv.path}
                    </a>
                  </td>
                  <td style="padding: 0.75rem; text-align: right; font-weight: 500;">
                    {pv.views}
                  </td>
                  <td style="padding: 0.75rem; text-align: right; color: var(--color-secondary, #666); font-size: 0.875rem;">
                    {formatDate(pv.last_seen)}
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      ) : (
        <p style="color: var(--color-secondary, #666); font-style: italic;">
          No page views recorded yet. Visit some pages to start tracking!
        </p>
      )}
    </section>

    <footer style="margin-top: 2rem; padding-top: 1rem; border-top: 1px solid var(--border-color, #e0e0e0); font-size: 0.875rem; color: var(--color-secondary, #666);">
      <p>
        Data refreshes on each page load. Analytics are stored in Supabase and never track personal information.
      </p>
    </footer>
  </main>
</Base>
