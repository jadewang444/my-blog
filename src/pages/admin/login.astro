---
/**
 * Admin login page
 * Simple form that posts to /api/admin/login
 */
import Base from '../../layouts/Base.astro';

export const prerender = false;

// If already logged in, redirect to admin
const sessionCookie = Astro.cookies.get('admin_session');
if (sessionCookie) {
  // Verify the cookie is valid (not expired)
  try {
    const session = JSON.parse(Buffer.from(sessionCookie.value, 'base64').toString('utf-8'));
    if (session.expires > Date.now()) {
      return Astro.redirect('/admin');
    }
  } catch (e) {
    // Invalid cookie, continue to login
  }
}

// Check for error message in query params
const error = Astro.url.searchParams.get('error');
---

<Base title="Admin Login" description="Login to view analytics">
  <main class="flex flex-col items-center justify-center min-h-[60vh]">
    <div style="max-width: 400px; width: 100%; padding: 2rem; border: 1px solid var(--border-color, #e0e0e0); border-radius: 0.5rem;">
      <h1 style="font-size: 1.5rem; font-weight: 600; margin-bottom: 1.5rem; text-align: center;">Admin Login</h1>
      
      {error && (
        <div style="padding: 0.75rem; margin-bottom: 1rem; background: #fee; border: 1px solid #fcc; border-radius: 0.25rem; color: #c00; font-size: 0.875rem;">
          {error === 'invalid' && 'Invalid username or password'}
          {error === 'unauthorized' && 'Please login to continue'}
        </div>
      )}

      <form method="POST" action="/api/admin/login">
        <div style="margin-bottom: 1rem;">
          <label for="username" style="display: block; margin-bottom: 0.25rem; font-weight: 500; font-size: 0.875rem;">
            Username
          </label>
          <input
            type="text"
            id="username"
            name="username"
            required
            autocomplete="username"
            style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color, #e0e0e0); border-radius: 0.25rem; font-size: 1rem;"
          />
        </div>

        <div style="margin-bottom: 1.5rem;">
          <label for="password" style="display: block; margin-bottom: 0.25rem; font-weight: 500; font-size: 0.875rem;">
            Password
          </label>
          <input
            type="password"
            id="password"
            name="password"
            required
            autocomplete="current-password"
            style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color, #e0e0e0); border-radius: 0.25rem; font-size: 1rem;"
          />
        </div>

        <button
          type="submit"
          style="width: 100%; padding: 0.75rem; background: var(--color-primary, #0066cc); color: white; border: none; border-radius: 0.25rem; font-size: 1rem; font-weight: 500; cursor: pointer;"
        >
          Login
        </button>
      </form>

      <p style="margin-top: 1rem; text-align: center; font-size: 0.875rem; color: var(--color-secondary, #666);">
        Session expires after 4 hours
      </p>
    </div>
  </main>
</Base>
